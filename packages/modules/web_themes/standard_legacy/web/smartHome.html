<!DOCTYPE html>
<html lang="de">

<head>
	<!-- theme for openWB layout for standard and dark, only css is different-->
	<!-- 2020 Michael Ortenstein -->

	<title>openWB - SmartHome</title>
	<meta charset="UTF-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="openWB">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="openWB">
	<meta name="description" content="openWB">
	<meta name="keywords" content="openWB">
	<meta name="author" content="Michael Ortenstein">
	<link rel="apple-touch-icon" sizes="72x72" href="/openWB/web/img/favicons/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/openWB/web/img/favicons/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/openWB/web/img/favicons/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/openWB/web/img/favicons/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/openWB/web/img/favicons/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/openWB/web/img/favicons/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/openWB/web/img/favicons/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/openWB/web/img/favicons/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/openWB/web/img/favicons/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/openWB/web/img/favicons/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/openWB/web/img/favicons/favicon-16x16.png">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="msapplication-TileImage" content="/openWB/web/img/favicons/ms-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="57x57" href="/openWB/web/img/favicons/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/openWB/web/img/favicons/apple-touch-icon-60x60.png">
	<link rel="manifest" href="/openWB/web/manifest.json">
	<link rel="shortcut icon" href="/openWB/web/img/favicons/favicon.ico">
	<!-- <link rel="apple-touch-startup-image" href="img/loader.gif"> -->
	<meta name="msapplication-config" content="/openWB/web/browserconfig.xml">
	<meta name="theme-color" content="#000000">

	<!-- Bootstrap -->
	<link rel="stylesheet" type="text/css" href="css/bootstrap-4.4.1/bootstrap.min.css">
	<!-- Bootstrap-Toggle -->
	<link rel="stylesheet" type="text/css" href="css/bootstrap4-toggle/bootstrap4-toggle.min.css">
	<!-- Normalize -->
	<link rel="stylesheet" type="text/css" href="css/normalize-8.0.1.css">
	<!-- Font Awesome, all styles -->
	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-5.8.2/css/all.css">
	<!-- local css due to async loading of theme css -->
	<style>
		#preloader {
			background-color: black;
			position: fixed;
			top: 0px;
			left: 0px;
			width: 100%;
			height: 100%;
			z-index: 999999;
		}

		#preloader-inner {
			margin-top: 150px;
			text-align: center;
		}

		#preloader-image {
			max-width: 300px;
		}

		#preloader-info {
			color: grey;
		}
	</style>
	<!-- important scripts to be loaded -->
	<script src="js/jquery-3.6.0.min.js"></script>
	<script src="js/bootstrap-4.4.1/bootstrap.bundle.min.js"></script>
	<script src="js/bootstrap4-toggle/bootstrap4-toggle.min.js"></script>
	<script>
		function getCookie(cname) {
			var name = cname + '=';
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for (var i = 0; i < ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
			return '';
		}
		var themeCookie = getCookie('openWBTheme');
		// include special Theme style
		$('head').append('<link rel="stylesheet" href="style.css?v=20221122">');
	</script>
</head>

<body>
	<!-- Preloader with Progress Bar -->
	<div id="preloader">
		<div id="preloader-inner">
			<div class="row">
				<div class="mx-auto d-block justify-content-center">
					<img id="preloader-image" src="/openWB/web/img/openWB_logo_dark.png" alt="openWB">
				</div>
			</div>
			<div id="preloader-info" class="row justify-content-center mt-2">
				<div class="col-10 col-sm-6">
					Bitte warten, während die Seite aufgebaut wird.
				</div>
			</div>
			<div class="row justify-content-center mt-2">
				<div class="col-10 col-sm-6">
					<div class="progress active">
						<div class="progress-bar progress-bar-success progress-bar-striped progress-bar-animated"
							id="preloader-bar" role="progressbar">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Landing Page -->
	<div id="nav-placeholder"></div>

	<div class="container regularTextSize">

		<!-- SmartHome info header -->
		<div class="card text-grey">
			<div class="card-header bg-darkgrey font-weight-bold">
				<div class="form-row">
					<div class="col-3">
						Gerät
					</div>
					<div class="col-3">
						Verbrauch
					</div>
					<div class="col-3">
						Modus
					</div>
					<div class="col-3">
						Laufzeit
					</div>
				</div>
			</div>
		</div>

		<!-- SmartHome Device 1 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="1">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 1</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
			<!-- device temperatures -->
			<div class="card-body SmartHomeTemp hide">
				<div class="row justify-content-center text-center text-black">
					<div class="col-4 hide" data-smart-home-temperature="0">
						<span class="temperature">1/0</span>
					</div>
					<div class="col-4 hide" data-smart-home-temperature="1">
						<span class="temperature">1/1</span>
					</div>
					<div class="col-4 hide" data-smart-home-temperature="2">
						<span class="temperature">1/2</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 1 -->

		<!-- SmartHome Device 2 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="2">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 2</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
			<!-- device temperatures -->
			<div class="card-body SmartHomeTemp hide">
				<div class="row justify-content-center text-center text-black">
					<div class="col-4 hide" data-smart-home-temperature="0">
						<span class="temperature">2/0</span>
					</div>
					<div class="col-4 hide" data-smart-home-temperature="1">
						<span class="temperature">2/1</span>
					</div>
					<div class="col-4 hide" data-smart-home-temperature="2">
						<span class="temperature">2/2</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 2 -->

		<!-- SmartHome Device 3 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="3">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 3</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 3 -->

		<!-- SmartHome Device 4 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="4">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 4</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 4 -->

		<!-- SmartHome Device 5 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="5">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 5</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 5 -->

		<!-- SmartHome Device 6 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="6">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 6</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 6 -->

		<!-- SmartHome Device 7 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="7">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 7</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 7 -->

		<!-- SmartHome Device 8 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="8">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 8</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 8 -->

		<!-- SmartHome Device 9 -->
		<div class="smarthome-device-card card border-dark text-grey hide" data-smart-home-device="9">
			<div class="card-header bg-lightgrey">
				<div class="form-row">
					<div class="col-3">
						<span class="cursor-pointer font-weight-bold charge-point-enabled enableDevice nameDevice">Device 9</span>
					</div>
					<div class="col-3">
						<span class="actualPowerDevice">lade Daten</span><span class="actualDailyYieldDevice"></span>
					</div>
					<div class="col-3">
						<span class="cursor-pointer actualModeDevice changeSHMode">lade Daten</span>
					</div>
					<div class="col-3">
						<span class="actualRunningTimeDevice">lade Daten</span>
					</div>
				</div>
			</div>
		</div><!-- SmartHome Device 9 -->

	</div> <!-- container -->

	<script>

		// load navbar, be careful: it loads asynchronous
		$.get(
			{ url: "navbar.html", cache: false },
			function (data) {
				$("#nav-placeholder").replaceWith(data);
			}
		);

		var timeOfLastMqttMessage = 0;  // holds timestamp of last received message
		var landingPageShown = false;  // holds flag for landing page being shown

		function processPreloader(mqttTopic) {
			// sets flag for topic received in topic-array
			// and updates the preloader progress bar
			// console.log("preloader handling message: "+mqttTopic);
			if (!landingPageShown) {
				var countTopicsReceived = 0;
				for (var index = 0; index < topicsToSubscribeFirst.length; index++) {
					if (topicsToSubscribeFirst[index][0] == mqttTopic && topicsToSubscribeFirst[index][1] == 0) {
						// topic found in array
						topicsToSubscribeFirst[index][1] = 1;  // mark topic as received
					};
					if (topicsToSubscribeFirst[index][1] > 0) {
						countTopicsReceived++;
					}
				};
				for (var index = 0; index < topicsToSubscribe.length; index++) {
					if (topicsToSubscribe[index][0] == mqttTopic && topicsToSubscribe[index][1] == 0) {
						// topic found in array
						topicsToSubscribe[index][1] = 1;  // mark topic as received
					};
					if (topicsToSubscribe[index][1] > 0) {
						countTopicsReceived++;
					}
				};
				// countTopicsToBeReceived holds all topics flagged 1 and not only those for preloader
				countTopicsReceived = countTopicsReceived - countTopicsNotForPreloader;
				var countTopicsToBeReceived = topicsToSubscribeFirst.length + topicsToSubscribe.length - countTopicsNotForPreloader;
				var percentageReceived = (countTopicsReceived / countTopicsToBeReceived * 100).toFixed(0);
				if (isNaN(percentageReceived)) {
					percentageReceived = 100;
				}
				var timeBetweenTwoMessages = Date.now() - timeOfLastMqttMessage;
				if (timeBetweenTwoMessages > 3000) {
					// latest after 3 sec without new messages
					percentageReceived = 100;
					// debug output
					topicsToSubscribeFirst.forEach((item, i) => {
						if (item[1] == 0) {
							console.warn('not received: ' + item[0]);
						}
					});
					topicsToSubscribe.forEach((item, i) => {
						if (item[1] == 0) {
							console.warn('not received: ' + item[0]);
						}
					});

				}
				timeOfLastMqttMessage = Date.now();
				$("#preloader-bar").width(percentageReceived + "%");
				$("#preloader-bar").text(percentageReceived + " %");
				if (percentageReceived == 100) {
					landingPageShown = true;
					setTimeout(function () {
						// delay a little bit
						$("#preloader").fadeOut(1000);
					}, 500);
				}
			}
		}

		var delayUserInput = (function () {
			// sets a timeout on call and resets timeout if called again for same id before timeout fires
			var timeoutHandles = {};
			return function (id, callback, ms) {
				if (timeoutHandles[id]) {
					clearTimeout(timeoutHandles[id]);
				};
				timeoutHandles[id] = setTimeout(function () {
					delete timeoutHandles[id];
					callback(id);
				}, ms);
			};
		})();

		$(document).ready(function () {

			// load scripts synchronously in order specified
			var scriptsToLoad = [
				// load mqtt library
				'js/mqttws31.js',
				// some helper functions
				'helperFunctions.js?ver=20221117',
				// functions for processing messages
				'processAllMqttMsg.js?ver=20230606',
				// functions performing mqtt and start mqtt-service
				'smartHomeMqttServices.js?ver=20230606',
			];
			scriptsToLoad.forEach(function (src) {
				var script = document.createElement('script');
				script.src = src;
				script.async = false;
				document.body.appendChild(script);
			});

			$('.enableDevice').click(function(event){
				// send mqtt set to enable/disable Device after click
				var deviceIndex = parseInt($(this).closest('[data-smart-home-device]').data('smart-home-device'));  // get attribute device-# of parent element
				var isLocked = $(this).hasClass("locked");
				if (isLocked) {
					if (!isNaN(deviceIndex) && deviceIndex > 0 && deviceIndex < 10) {
						var isEnabled = $(this).hasClass("charge-point-enabled")
						if (isEnabled) {
							publish(0, "openWB/set/LegacySmartHome/config/set/Devices/" + deviceIndex + "/device_manual_control");
							$(this).removeClass('charge-point-enabled').removeClass('charge-point-disabled').addClass('charge-point-waiting');
						} else {
							publish(1, "openWB/set/LegacySmartHome/config/set/Devices/" + deviceIndex + "/device_manual_control");
							$(this).removeClass('charge-point-enabled').removeClass('charge-point-disabled').addClass('charge-point-waiting');
						}
					}
				}
			});

			$('.changeSHMode').click(function(event){
				// send mqtt set to enable/disable Device after click
				var deviceIndex = parseInt($(this).closest('[data-smart-home-device]').data('smart-home-device'));  // get attribute device-# of parent element
				if ($(this).text() == "Automatik") {
					publish(1, "openWB/set/LegacySmartHome/config/set/Devices/" + deviceIndex + "/mode");
				} else {
					publish(0, "openWB/set/LegacySmartHome/config/set/Devices/" + deviceIndex + "/mode");
				}
			});

			// register an event listener for changes in visibility
			let hidden;
			let visibilityChange;
			if (typeof document.hidden !== 'undefined') { // Opera 12.10 and Firefox 18 and later support
				hidden = 'hidden';
				visibilityChange = 'visibilitychange';
			} else if (typeof document.msHidden !== 'undefined') {
				hidden = 'msHidden';
				visibilityChange = 'msvisibilitychange';
			} else if (typeof document.webkitHidden !== 'undefined') {
				hidden = 'webkitHidden';
				visibilityChange = 'webkitvisibilitychange';
			}

		});  // end document ready
	</script>

</body>

</html>
