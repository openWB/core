import{l as w,J as E,K as M,L as P,M as A,F as T}from"./vendor-fortawesome-8429033b.js";import{C as $}from"./index-9f669d1c.js";import{C as F,p as V,a as z,L as I,b as N,P as H,c as J,T as Z,i as G,d as O,e as U}from"./vendor-chartjs-e7e999df.js";import{_ as Y,q as g,l as h,m,u as S,A as p,K as u,v as x,y as D,F as C,G as b,x as q}from"./vendor-2323dc6c.js";import"./vendor-bootstrap-c20e9318.js";import"./vendor-jquery-2fe26a31.js";import"./vendor-axios-56f89411.js";import"./vendor-sortablejs-43c17404.js";import"./vendor-luxon-7a64d8c5.js";w.add(E,M,P,A);F.register(V,z,I,N,H,J,Z,G,O);const Q={name:"OpenwbMonthlyChart",components:{ChartjsLine:U,FontAwesomeIcon:T},mixins:[$],emits:["sendCommand"],data(){return{mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/monthly/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentMonth:"",monthlyChartRequestData:{month:"",year:""},datasetTemplates:{"counter-energy":{label:"Zähler",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,lineTension:.2,hidden:!1,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-energy":{label:"PV",jsonKey:null,borderColor:"rgba(0, 255, 0, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-energy":{label:"Speicher",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-energy":{label:"Ladepunkt",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0},legend:{display:!0},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:3}},responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",time:{unit:"day",tooltipFormat:"D"},display:!0,title:{display:!0,text:"Tag"},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:31},grid:{}},y1:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Energie [kWh]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{monthlyChartDate:{get(){return this.monthlyChartRequestData.year+"-"+this.monthlyChartRequestData.month},set(r){let e=r.split("-");this.monthlyChartRequestData.year=e[0],this.monthlyChartRequestData.month=e[1]}},commandData(){return{month:this.monthlyChartRequestData.year+this.monthlyChartRequestData.month}},chartDataRead(){return this.chartDataObject!=null},chartDataHasEntries(){return this.chartDataObject.length>0},chartTotals(){if(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month]){if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month],"totals"))return this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month].totals;{var r={bat:{},counter:{},pv:{},cp:{}};const o=["imported","exported"],n=(l,d,f)=>{const i=f.split(".");o.includes(i[i.length-1])&&(Object.prototype.hasOwnProperty.call(r[i[0]],[i[1]])||(r[i[0]][i[1]]={}),r[i[0]][i[1]][i[2]]=Math.floor(d-l))},s=(l,d,f,i="")=>{for(var c in d)d[c]!==null&&typeof d[c]=="object"?s(l[c],d[c],f,i?i+"."+c:c):f.apply(this,[l[c],d[c],i?i+"."+c:c])};var e=this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month];const t=e[0],a=e[e.length-1];return s(t,a,n),r}}},chartDataObject(){if(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month]){var r=this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month];Object.prototype.hasOwnProperty.call(r,"entries")&&(console.debug("upgraded chart data received"),r=r.entries);var e=void 0,o=JSON.parse(JSON.stringify(r)).map(n=>{if(n.timestamp=n.timestamp*1e3,e!==void 0){var s=["pv","counter","bat","cp"];return s.forEach(t=>{Object.entries(n[t]).forEach(([a,l])=>{e[t][a]&&Object.keys(l).forEach(()=>{switch(t){case"pv":Object.prototype.hasOwnProperty.call(n[t][a],"exported")&&Object.prototype.hasOwnProperty.call(e[t][a],"exported")&&(n[t][a].energy=(n[t][a].exported-e[t][a].exported)/1e3);break;case"counter":Object.prototype.hasOwnProperty.call(n[t][a],"imported")&&Object.prototype.hasOwnProperty.call(e[t][a],"imported")&&Object.prototype.hasOwnProperty.call(n[t][a],"exported")&&Object.prototype.hasOwnProperty.call(e[t][a],"exported")&&(n[t][a].energy=(n[t][a].imported-e[t][a].imported-(n[t][a].exported-e[t][a].exported))/1e3,n[t][a].energyImport=Math.max(0,n[t][a].energy),n[t][a].energyExport=Math.min(0,n[t][a].energy));break;case"bat":Object.prototype.hasOwnProperty.call(n[t][a],"imported")&&Object.prototype.hasOwnProperty.call(e[t][a],"imported")&&Object.prototype.hasOwnProperty.call(n[t][a],"exported")&&Object.prototype.hasOwnProperty.call(e[t][a],"exported")&&(n[t][a].energy=(n[t][a].imported-e[t][a].imported-(n[t][a].exported-e[t][a].exported))/1e3,n[t][a].energyImport=Math.max(0,n[t][a].energy),n[t][a].energyExport=Math.min(0,n[t][a].energy));break;case"cp":Object.prototype.hasOwnProperty.call(n[t][a],"imported")&&Object.prototype.hasOwnProperty.call(e[t][a],"imported")&&(n[t][a].energy=(n[t][a].imported-e[t][a].imported)/1e3);break}})})}),e=n,n}else{e=n;return}});return o.shift(),o}},chartData(){var r=["pv","counter","bat","cp","ev"];const e=this.chartDataObject[this.chartDataObject.length-1];return e&&r.forEach(o=>{Object.entries(e[o]).forEach(([n,s])=>{Object.keys(s).forEach(t=>{this.initDataset(o,n,t)})})}),this.chartDatasets}},methods:{getCardSubtype(r){switch(r){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";default:return"secondary"}},getCardIcon(r){switch(r){case"bat":return["fas","car-battery"];case"counter":return["fas","gauge-high"];case"cp":return["fas","charging-station"];case"pv":return["fas","solar-panel"];default:return}},getDatasetHidden(r,e){return console.debug("getDatasetHidden",r,e),!1},getTotalsLabel(r,e=void 0,o=void 0){var n="*test*";if(!e&&!o){switch(r){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";default:console.warn("unknown group key:",r)}return"*"+r+"*"}if(e&&!o){if(e=="all")return"Summe";var s=e.match(/\d+$/),t="";switch(r){case"cp":t="openWB/chargepoint/"+s+"/config";break;case"ev":t="openWB/vehicle/"+s+"/name";break;default:t="openWB/system/device/+/component/"+s+"/config"}var a=Object.keys(this.getWildcardTopics(t))[0];if(a)switch(r){case"pv":return this.$store.state.mqtt[a].name;case"counter":return this.$store.state.mqtt[a].name;case"bat":return this.$store.state.mqtt[a].name;case"cp":return this.$store.state.mqtt[a].name;case"ev":return this.$store.state.mqtt[a];default:console.warn("unknown group key:",r)}else console.warn("topic not found for:",r,e);return"+"+r+"+"+e+"+"}if(e&&o){switch(r){case"bat":case"cp":switch(o){case"imported":return"Ladung";case"exported":return"Entladung";default:console.warn("unknown measurement key:",r,o)}break;case"counter":switch(o){case"imported":return"Bezug/Verbrauch";case"exported":return"Einspeisung/Erzeugung";default:console.warn("unknown measurement key:",r,o)}break;case"pv":switch(o){case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",r,o)}break;default:console.warn("unknown group key:",r)}return"*"+r+"+"+e+"+"+o+"*"}return n},getDatasetLabel(r,e,o,n){var s="*"+n;if(e=="all")switch(r){case"pv":s="PV (Summe)";break;case"bat":switch(s="Speicher",o){case"imported":s+=" (Ladung, Summe)";break;case"exported":s+=" (Entladung, Summe)";break;case"soc":s+=" SoC (Summe)";break;default:s+=" (Summe)"}break;case"cp":switch(s="Ladepunkte",o){case"imported":s+=" (Ladung, Summe)";break;case"exported":s+=" (Entladung, Summe)";break;case"soc":s+=" SoC (Summe)";break;default:s+=" (Summe)"}break}else{var t=e.match(/\d+$/),a="";switch(r){case"cp":a="openWB/chargepoint/"+t+"/config";break;case"ev":a="openWB/vehicle/"+t+"/name";break;default:a="openWB/system/device/+/component/"+t+"/config"}var l=Object.keys(this.getWildcardTopics(a))[0];if(l in this.$store.state.mqtt)switch(r){case"pv":s=this.$store.state.mqtt[l].name;break;case"counter":switch(s=this.$store.state.mqtt[l].name,o){case"imported":s+=" (Bezug)";break;case"exported":s+=" (Einspeisung)";break}break;case"bat":switch(s=this.$store.state.mqtt[l].name,o){case"imported":s+=" (Ladung)";break;case"exported":s+=" (Entladung)";break;case"soc":s+=" SoC";break}break;case"cp":switch(s=this.$store.state.mqtt[l].name,o){case"imported":s+=" (Ladung)";break;case"exported":s+=" (Entladung)";break;case"soc":s+=" SoC";break}break;case"ev":s=this.$store.state.mqtt[l];break}else console.warn("could not get name for dataset",n)}return s},getDatasetIndex(r){let e=this.chartDatasets.datasets.findIndex(o=>o.jsonKey==r);if(e!=-1)return e},addDataset(r,e,o,n){console.debug("adding new dataset",r,e,o,n);var s=r+"-"+o;if(this.datasetTemplates[s]){var t=JSON.parse(JSON.stringify(this.datasetTemplates[s]));return t.parsing.yAxisKey=n,t.jsonKey=n,t.data=this.chartDataObject,t.label=this.getDatasetLabel(r,e,o,n),t.labelSuffix!=null&&(t.label=t.label+t.labelSuffix),e=="all"&&(t.hidden=!1),this.chartDatasets.datasets.push(t)-1}else console.warn("no matching template found for: "+n+" with template: "+s)},initDataset(r,e,o){const n=["energy"],s=r+"."+e+"."+o;if(n.includes(o)){var t=this.getDatasetIndex(s);const a=this.getDatasetHidden(r,e);t==null&&!a&&(t=this.addDataset(r,e,o,s)),t!=null&&a&&(console.info("component hidden:",r,e,o,t),this.chartDatasets.datasets.splice(t,1))}},requestMonthlyChart(){if(document.forms.monthlyChartForm.reportValidity())this.chartDatasets.datasets=[],this.$emit("sendCommand",{command:"getMonthlyLog",data:this.commandData});else{console.log("form invalid");return}}},mounted(){const r=new Date;this.currentMonth=this.monthlyChartDate=r.getFullYear()+"-"+String(r.getMonth()+1).padStart(2,"0"),this.requestMonthlyChart()}},X={class:"monthlyChart"},R={name:"monthlyChartForm"},j={class:"row justify-content-center"},K={key:1},tt={key:1};function et(r,e,o,n,s,t){const a=g("openwb-base-text-input"),l=g("openwb-base-click-button"),d=g("openwb-base-card"),f=g("openwb-base-alert"),i=g("chartjs-line"),c=g("font-awesome-icon"),W=g("openwb-base-heading");return h(),m("div",X,[S("form",R,[p(d,{title:"Filter",collapsible:!0,collapsed:!1},{footer:u(()=>[S("div",j,[p(l,{class:"col-4 btn-success",onButtonClicked:e[1]||(e[1]=v=>t.requestMonthlyChart())},{default:u(()=>[x(" Daten anfordern ")]),_:1})])]),default:u(()=>[p(a,{title:"Monat",subtype:"month",min:"2018-01",max:s.currentMonth,modelValue:t.monthlyChartDate,"onUpdate:modelValue":e[0]||(e[0]=v=>t.monthlyChartDate=v)},null,8,["max","modelValue"])]),_:1}),t.chartDataRead?(h(),m("div",K,[t.chartDataHasEntries?(h(),m("div",tt,[p(d,{title:"Diagramm",collapsible:!0,collapsed:!1},{default:u(()=>[p(i,{chartData:t.chartData,chartOptions:s.chartOptions},null,8,["chartData","chartOptions"])]),_:1}),p(d,{title:"Summen",collapsible:!0,collapsed:!0},{default:u(()=>[(h(!0),m(C,null,b(t.chartTotals,(v,y)=>(h(),D(d,{key:y,collapsible:!0,collapsed:!0,subtype:t.getCardSubtype(y)},{header:u(()=>[p(c,{"fixed-width":"",icon:t.getCardIcon(y)},null,8,["icon"]),x(" "+q(t.getTotalsLabel(y)),1)]),default:u(()=>[(h(!0),m(C,null,b(v,(B,_)=>(h(),m("div",{key:_},[p(W,null,{default:u(()=>[x(q(t.getTotalsLabel(y,_)),1)]),_:2},1024),(h(!0),m(C,null,b(B,(L,k)=>(h(),m("div",{key:k},[p(a,{title:t.getTotalsLabel(y,_,k),readonly:"",class:"text-right",unit:"kWh","model-value":r.formatNumber(L/1e3,3)},null,8,["title","model-value"])]))),128))]))),128))]),_:2},1032,["subtype"]))),128))]),_:1})])):(h(),D(f,{key:0,subtype:"info"},{default:u(()=>[x(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ")]),_:1}))])):(h(),D(f,{key:0,subtype:"info"},{default:u(()=>[x(" Es wurden noch keine Daten abgerufen. ")]),_:1}))])])}const ht=Y(Q,[["render",et],["__file","/opt/openWB-dev/openwb-ui-settings/src/views/MonthlyChart.vue"]]);export{ht as default};
