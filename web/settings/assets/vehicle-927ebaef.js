import{_ as m,a5 as p,a6 as g,a7 as f,q as l,k as b,l as k,B as a,M as s,x as r,u as v}from"./vendor-f0f38b48.js";import{a as w}from"./vendor-axios-e59ef189.js";import{C as y}from"./index-ef2dd306.js";import"./vendor-sortablejs-cbf37f8f.js";import"./vendor-fortawesome-9fdc06a9.js";import"./vendor-bootstrap-384bc385.js";import"./vendor-jquery-8576ed22.js";const C={name:"VehicleSocTesla",emits:["update:configuration"],props:{vehicleId:{required:!0,type:Number},vehicle:{required:!0,type:Object}},data(){return{tesla_api_oauth2:"https://auth.tesla.com/oauth2/v3",tesla_api_redirect:"https://auth.tesla.com/void/callback",tesla_api_owners:"https://owner-api.teslamotors.com/oauth/token",user_agent:"Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148",code_challenge:null,code_verifier:null,page_not_found_url:null}},mixins:[y],methods:{updateConfiguration(e,n=void 0){this.$emit("update:configuration",{value:e,object:n})},tesla_login_window(){this.tesla_gen_challenge();var e=window.open(this.tesla_gen_url(),"TeslaLogin","width=800,height=600,status=yes,scrollbars=yes,resizable=yes");e.focus()},tesla_gen_challenge(){this.code_verifier=p.encode(g.randomBytes(86)).replace(/[^a-zA-Z0-9]/gi,"").substring(0,86);const e=g.createHash("sha256").update(this.code_verifier).digest();this.code_challenge=p.encode(e),console.debug(this.code_verifier,this.code_verifier.length,this.code_challenge,this.code_challenge.length)},tesla_gen_url(){const e=new URL(this.tesla_api_oauth2+"/authorize/");return e.searchParams.append("client_id","ownerapi"),e.searchParams.append("code_challenge",this.code_challenge),e.searchParams.append("code_challenge_method","S256"),e.searchParams.append("redirect_uri",this.tesla_api_redirect),e.searchParams.append("response_type","code"),e.searchParams.append("scope","openid email offline_access"),e.searchParams.append("state","myteslaapp"),e},async tesla_login(){const e=f.parse(this.page_not_found_url,!0).query;if(console.debug("queryObject",e),!e.code){console.error("Something is wrong... Code does not exist in URL"),this.$root.postClientMessage("Die eingegebene URL ist ungültig.","danger");return}const n={url:this.tesla_api_owners,user_agent:this.user_agent,data:{grant_type:"authorization_code",client_id:"ownerapi",code:e.code,code_verifier:this.code_verifier,redirect_uri:this.tesla_api_redirect}};try{const t=await w.post(location.protocol+"//"+location.host+"/openWB/web/settings/modules/vehicles/tesla/tesla.php",JSON.parse(JSON.stringify(n)),{headers:{"Content-Type":"application/json",Accept:"application/json"}});console.debug("response",t),this.updateConfiguration({access_token:t.data.access_token,refresh_token:t.data.refresh_token,created_at:t.data.created_at,expires_in:t.data.expires_in},"configuration.token"),this.$root.postClientMessage("Token erfolgreich abgerufen.","success")}catch(t){console.error(t),this.$root.postClientMessage("Beim Abruf der Token ist ein Fehler aufgetreten!<pre>"+t+"</pre>","danger")}}}},T={class:"vehicle-soc-tesla"},x=v("hr",null,null,-1);function B(e,n,t,U,u,i){const d=l("openwb-base-number-input"),h=l("openwb-base-heading"),_=l("openwb-base-button-input"),c=l("openwb-base-text-input");return b(),k("div",T,[a(d,{title:"Fahrzeug-ID",required:"",min:0,"model-value":t.vehicle.configuration.tesla_ev_num,"onUpdate:modelValue":n[0]||(n[0]=o=>i.updateConfiguration(o,"configuration.tesla_ev_num"))},{help:s(()=>[r(' Die ID des Fahrzeugs bei Tesla. Normalerweise "0" bei nur einem Fahrzeug im Konto. ')]),_:1},8,["model-value"]),a(h,null,{default:s(()=>[r("Token abrufen oder eingeben")]),_:1}),a(_,{title:"1. Anmelden",buttonText:"Bei Tesla Anmelden",subtype:"success",onButtonClicked:i.tesla_login_window},{help:s(()=>[r(" Es wird ein neues Browserfenster geöffnet, in dem Sie sich bei Tesla mit Ihren Zugangsdaten anmelden können. ")]),_:1},8,["onButtonClicked"]),a(c,{title:"2. URL kopieren und einfügen",subtype:"url",emptyValue:null,modelValue:u.page_not_found_url,"onUpdate:modelValue":n[1]||(n[1]=o=>u.page_not_found_url=o)},{help:s(()=>[r(' Hier die komplette URL (Text in der Adresszeile) aus dem geöffneten Browserfenster einfügen, wenn dort "Page Not Found" angezeigt wird. ')]),_:1},8,["modelValue"]),a(_,{title:"3. Token abrufen",buttonText:"Jetzt abrufen",subtype:"success",disabled:u.page_not_found_url===null,onButtonClicked:i.tesla_login},{help:s(()=>[r(" Der in der eingegebenen URL enthaltene Code wird genutzt, um ein Anmeldetoken bei Tesla abzurufen. Ist dies erfolgreich, so werden die Daten des Token in den weiteren Feldern automatisch eingegeben. ")]),_:1},8,["disabled","onButtonClicked"]),x,a(c,{title:"Access Token",pattern:"^(ey).*",required:"","model-value":t.vehicle.configuration.token?t.vehicle.configuration.token.access_token:"","onUpdate:modelValue":n[2]||(n[2]=o=>i.updateConfiguration(o,"configuration.token.access_token"))},null,8,["model-value"]),a(c,{title:"Refresh Token",pattern:"^(ey).*",required:"","model-value":t.vehicle.configuration.token?t.vehicle.configuration.token.refresh_token:"","onUpdate:modelValue":n[3]||(n[3]=o=>i.updateConfiguration(o,"configuration.token.refresh_token"))},null,8,["model-value"]),a(d,{title:"Erstellt um",required:"","model-value":t.vehicle.configuration.token?t.vehicle.configuration.token.created_at:0,"onUpdate:modelValue":n[4]||(n[4]=o=>i.updateConfiguration(o,"configuration.token.created_at"))},{help:s(()=>[r(" Unix Timestamp des Zeitpunktes, an dem das Token erzeugt wurde. ")]),_:1},8,["model-value"]),a(d,{title:"Ungültig in",unit:"s",required:"","model-value":t.vehicle.configuration.token?t.vehicle.configuration.token.expires_in:0,"onUpdate:modelValue":n[5]||(n[5]=o=>i.updateConfiguration(o,"configuration.token.expires_in"))},{help:s(()=>[r(" Zeitspanne in Sekunden, nach der das Token ungültig wird. ")]),_:1},8,["model-value"])])}const M=m(C,[["render",B],["__file","/opt/openWB-dev/openwb-ui-settings/src/components/vehicles/tesla/vehicle.vue"]]);export{M as default};
