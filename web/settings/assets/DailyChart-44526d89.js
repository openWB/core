import{l as B,J as A,K as E,L as T,M as P,F as M}from"./vendor-fortawesome-b3888957.js";import{C as z}from"./index-d1717957.js";import{C as F,p as $,a as I,L as V,b as N,P as H,c as J,T as Z,i as G,d as O,e as U}from"./vendor-chartjs-404afee0.js";import{_ as Y,q as g,l as p,m,u as S,A as h,K as c,v as x,y as v,F as C,G as _,x as w}from"./vendor-6ce277ad.js";import"./vendor-bootstrap-d19731a7.js";import"./vendor-jquery-44ace3c0.js";import"./vendor-axios-03377982.js";import"./vendor-sortablejs-bb80b62c.js";import"./vendor-luxon-7a64d8c5.js";B.add(A,E,T,P);F.register($,I,V,N,H,J,Z,G,O);const Q={name:"OpenwbDailyChart",components:{ChartjsLine:U,FontAwesomeIcon:M},mixins:[z],emits:["sendCommand"],data(){return{mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/daily/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentDay:"",dailyChartRequestData:{day:"",month:"",year:""},datasetTemplates:{"counter-power":{label:"Zähler",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,lineTension:.2,hidden:!1,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-power":{label:"PV",jsonKey:null,borderColor:"rgba(0, 255, 0, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-power":{label:"Speicher",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!1,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-soc":{label:"Speicher SoC",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,lineTension:.2,borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-power":{label:"Ladepunkt",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y1",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"ev-soc":{label:"Fahrzeug SoC",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,lineTension:.2,borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0},legend:{display:!0},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:0}},responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",time:{unit:"minute",tooltipFormat:"DD T"},display:!0,title:{display:!0,text:"Zeit"},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:24},grid:{}},y1:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Leistung [kW]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}},y2:{position:"right",type:"linear",display:"auto",suggestedMin:0,suggestedMax:100,title:{font:{size:12},display:!0,text:"SoC [%]"},grid:{display:!1},ticks:{font:{size:12},stepSize:10,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{dailyChartDate:{get(){return this.dailyChartRequestData.year+"-"+this.dailyChartRequestData.month+"-"+this.dailyChartRequestData.day},set(a){let t=a.split("-");this.dailyChartRequestData.year=t[0],this.dailyChartRequestData.month=t[1],this.dailyChartRequestData.day=t[2]}},commandData(){return{day:this.dailyChartRequestData.year+this.dailyChartRequestData.month+this.dailyChartRequestData.day}},chartDataRead(){return this.chartDataObject!=null},chartDataHasEntries(){return this.chartDataObject.length>0},chartTotals(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day],"totals"))return this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day].totals;{var a={bat:{},counter:{},pv:{},cp:{}};const o=["imported","exported"],s=(r,d,f)=>{const l=f.split(".");o.includes(l[l.length-1])&&(Object.prototype.hasOwnProperty.call(a[l[0]],[l[1]])||(a[l[0]][l[1]]={}),a[l[0]][l[1]][l[2]]=Math.floor(d-r))},i=(r,d,f,l="")=>{for(var u in d)d[u]!==null&&typeof d[u]=="object"?i(r[u],d[u],f,l?l+"."+u:u):f.apply(this,[r[u],d[u],l?l+"."+u:u])};var t=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];const n=t[0],e=t[t.length-1];return i(n,e,s),a}}},chartDataObject(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){var a=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];Object.prototype.hasOwnProperty.call(a,"entries")&&(console.debug("upgraded chart data received"),a=a.entries);var t=void 0,o=JSON.parse(JSON.stringify(a)).map(s=>{if(s.timestamp=s.timestamp*1e3,t!==void 0){const n=s.timestamp-t.timestamp;var i=["pv","counter","bat","cp"];return i.forEach(e=>{Object.entries(s[e]).forEach(([r,d])=>{t[e][r]&&Object.keys(d).forEach(()=>{switch(e){case"pv":Object.prototype.hasOwnProperty.call(s[e][r],"exported")&&Object.prototype.hasOwnProperty.call(t[e][r],"exported")&&(s[e][r].power=Math.floor((s[e][r].exported-t[e][r].exported)/(n/1e3/3600))/1e3);break;case"counter":Object.prototype.hasOwnProperty.call(s[e][r],"imported")&&Object.prototype.hasOwnProperty.call(t[e][r],"imported")&&Object.prototype.hasOwnProperty.call(s[e][r],"exported")&&Object.prototype.hasOwnProperty.call(t[e][r],"exported")&&(s[e][r].power=Math.floor((s[e][r].imported-t[e][r].imported-(s[e][r].exported-t[e][r].exported))/(n/1e3/3600))/1e3,s[e][r].powerImport=Math.max(0,s[e][r].power),s[e][r].powerExport=Math.min(0,s[e][r].power));break;case"bat":Object.prototype.hasOwnProperty.call(s[e][r],"imported")&&Object.prototype.hasOwnProperty.call(t[e][r],"imported")&&Object.prototype.hasOwnProperty.call(s[e][r],"exported")&&Object.prototype.hasOwnProperty.call(t[e][r],"exported")&&(s[e][r].power=Math.floor((s[e][r].imported-t[e][r].imported-(s[e][r].exported-t[e][r].exported))/(n/1e3/3600))/1e3,s[e][r].powerImport=Math.max(0,s[e][r].power),s[e][r].powerExport=Math.min(0,s[e][r].power));break;case"cp":Object.prototype.hasOwnProperty.call(s[e][r],"imported")&&Object.prototype.hasOwnProperty.call(t[e][r],"imported")&&(s[e][r].power=Math.floor((s[e][r].imported-t[e][r].imported)/(n/1e3/3600))/1e3);break}})})}),t=s,s}else{t=s;return}});return o.shift(),o}},chartData(){var a=["pv","counter","bat","cp","ev"];const t=this.chartDataObject[this.chartDataObject.length-1];return t&&a.forEach(o=>{Object.entries(t[o]).forEach(([s,i])=>{Object.keys(i).forEach(n=>{this.initDataset(o,s,n)})})}),this.chartDatasets}},methods:{getCardSubtype(a){switch(a){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";default:return"secondary"}},getCardIcon(a){switch(a){case"bat":return["fas","car-battery"];case"counter":return["fas","gauge-high"];case"cp":return["fas","charging-station"];case"pv":return["fas","solar-panel"];default:return}},getDatasetHidden(a,t){return console.debug("getDatasetHidden",a,t),!1},getTotalsLabel(a,t=void 0,o=void 0){var s="*test*";if(!t&&!o){switch(a){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";default:console.warn("unknown group key:",a)}return"*"+a+"*"}if(t&&!o){if(t=="all")return"Summe";var i=t.match(/\d+$/),n="";switch(a){case"cp":n="openWB/chargepoint/"+i+"/config";break;case"ev":n="openWB/vehicle/"+i+"/name";break;default:n="openWB/system/device/+/component/"+i+"/config"}var e=Object.keys(this.getWildcardTopics(n))[0];if(e)switch(a){case"pv":return this.$store.state.mqtt[e].name;case"counter":return this.$store.state.mqtt[e].name;case"bat":return this.$store.state.mqtt[e].name;case"cp":return this.$store.state.mqtt[e].name;case"ev":return this.$store.state.mqtt[e];default:console.warn("unknown group key:",a)}else console.warn("topic not found for:",a,t);return"+"+a+"+"+t+"+"}if(t&&o){switch(a){case"bat":case"cp":switch(o){case"imported":return"Ladung";case"exported":return"Entladung";default:console.warn("unknown measurement key:",a,o)}break;case"counter":switch(o){case"imported":return"Bezug/Verbrauch";case"exported":return"Einspeisung/Erzeugung";default:console.warn("unknown measurement key:",a,o)}break;case"pv":switch(o){case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",a,o)}break;default:console.warn("unknown group key:",a)}return"*"+a+"+"+t+"+"+o+"*"}return s},getDatasetLabel(a,t,o,s){var i="*"+s;if(t=="all")switch(a){case"pv":i="PV (Summe)";break;case"bat":switch(i="Speicher",o){case"imported":i+=" (Ladung, Summe)";break;case"exported":i+=" (Entladung, Summe)";break;case"soc":i+=" SoC (Summe)";break;default:i+=" (Summe)"}break;case"cp":switch(i="Ladepunkte",o){case"imported":i+=" (Ladung, Summe)";break;case"exported":i+=" (Entladung, Summe)";break;case"soc":i+=" SoC (Summe)";break;default:i+=" (Summe)"}break}else{var n=t.match(/\d+$/),e="";switch(a){case"cp":e="openWB/chargepoint/"+n+"/config";break;case"ev":e="openWB/vehicle/"+n+"/name";break;default:e="openWB/system/device/+/component/"+n+"/config"}var r=Object.keys(this.getWildcardTopics(e))[0];if(r in this.$store.state.mqtt)switch(a){case"pv":i=this.$store.state.mqtt[r].name;break;case"counter":switch(i=this.$store.state.mqtt[r].name,o){case"imported":i+=" (Bezug)";break;case"exported":i+=" (Einspeisung)";break}break;case"bat":switch(i=this.$store.state.mqtt[r].name,o){case"imported":i+=" (Ladung)";break;case"exported":i+=" (Entladung)";break;case"soc":i+=" SoC";break}break;case"cp":switch(i=this.$store.state.mqtt[r].name,o){case"imported":i+=" (Ladung)";break;case"exported":i+=" (Entladung)";break;case"soc":i+=" SoC";break}break;case"ev":i=this.$store.state.mqtt[r];break}else console.warn("could not get name for dataset",s)}return i},getDatasetIndex(a){let t=this.chartDatasets.datasets.findIndex(o=>o.jsonKey==a);if(t!=-1)return t},addDataset(a,t,o,s){console.debug("adding new dataset",a,t,o,s);var i=a+"-"+o;if(this.datasetTemplates[i]){var n=JSON.parse(JSON.stringify(this.datasetTemplates[i]));return n.parsing.yAxisKey=s,n.jsonKey=s,n.data=this.chartDataObject,n.label=this.getDatasetLabel(a,t,o,s),n.labelSuffix!=null&&(n.label=n.label+n.labelSuffix),t=="all"&&(n.hidden=!1),this.chartDatasets.datasets.push(n)-1}else console.warn("no matching template found for: "+s+" with template: "+i)},initDataset(a,t,o){const s=["power","soc"],i=a+"."+t+"."+o;if(s.includes(o)){var n=this.getDatasetIndex(i);const e=this.getDatasetHidden(a,t);n==null&&!e&&(n=this.addDataset(a,t,o,i)),n!=null&&e&&(console.info("component hidden:",a,t,o,n),this.chartDatasets.datasets.splice(n,1))}},requestDailyChart(){if(document.forms.dailyChartForm.reportValidity())this.chartDatasets.datasets=[],this.$emit("sendCommand",{command:"getDailyLog",data:this.commandData});else{console.log("form invalid");return}}},mounted(){const a=new Date;this.currentDay=this.dailyChartDate=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0"),this.requestDailyChart()}},X={class:"dailyChart"},R={name:"dailyChartForm"},j={class:"row justify-content-center"},K={key:1},tt={key:1};function et(a,t,o,s,i,n){const e=g("openwb-base-text-input"),r=g("openwb-base-click-button"),d=g("openwb-base-card"),f=g("openwb-base-alert"),l=g("chartjs-line"),u=g("font-awesome-icon"),q=g("openwb-base-heading");return p(),m("div",X,[S("form",R,[h(d,{title:"Filter",collapsible:!0,collapsed:!1},{footer:c(()=>[S("div",j,[h(r,{class:"col-4 btn-success",onButtonClicked:t[1]||(t[1]=D=>n.requestDailyChart())},{default:c(()=>[x(" Daten anfordern ")]),_:1})])]),default:c(()=>[h(e,{title:"Datum",subtype:"date",min:"2018-01-01",max:i.currentDay,modelValue:n.dailyChartDate,"onUpdate:modelValue":t[0]||(t[0]=D=>n.dailyChartDate=D)},null,8,["max","modelValue"])]),_:1}),n.chartDataRead?(p(),m("div",K,[n.chartDataHasEntries?(p(),m("div",tt,[h(d,{title:"Diagramm",collapsible:!0,collapsed:!1},{default:c(()=>[h(l,{chartData:n.chartData,chartOptions:i.chartOptions},null,8,["chartData","chartOptions"])]),_:1}),h(d,{title:"Summen",collapsible:!0,collapsed:!0},{default:c(()=>[(p(!0),m(C,null,_(n.chartTotals,(D,y)=>(p(),v(d,{key:y,collapsible:!0,collapsed:!0,subtype:n.getCardSubtype(y)},{header:c(()=>[h(u,{"fixed-width":"",icon:n.getCardIcon(y)},null,8,["icon"]),x(" "+w(n.getTotalsLabel(y)),1)]),default:c(()=>[(p(!0),m(C,null,_(D,(W,b)=>(p(),m("div",{key:b},[h(q,null,{default:c(()=>[x(w(n.getTotalsLabel(y,b)),1)]),_:2},1024),(p(!0),m(C,null,_(W,(L,k)=>(p(),m("div",{key:k},[h(e,{title:n.getTotalsLabel(y,b,k),readonly:"",class:"text-right",unit:"kWh","model-value":a.formatNumber(L/1e3,3)},null,8,["title","model-value"])]))),128))]))),128))]),_:2},1032,["subtype"]))),128))]),_:1})])):(p(),v(f,{key:0,subtype:"info"},{default:c(()=>[x(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ")]),_:1}))])):(p(),v(f,{key:0,subtype:"info"},{default:c(()=>[x(" Es wurden noch keine Daten abgerufen. ")]),_:1}))])])}const pt=Y(Q,[["render",et],["__file","/opt/openWB-dev/openwb-ui-settings/src/views/DailyChart.vue"]]);export{pt as default};
