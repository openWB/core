import{l as B,J as I,K as A,L as E,M as R,P as L,F as P}from"./vendor-fortawesome-63a0ad05.js";import{C as M}from"./index-13aad0d9.js";import{C as $,p as H,a as V,L as z,b as T,P as F,c as N,T as O,i as J,d as Z,e as G}from"./vendor-chartjs-f0fbe832.js";import{_ as U,p as y,k as d,l as u,q as w,A as m,L as g,y as C,u as b,G as D,I as _,x as W}from"./vendor-20bb207d.js";import"./vendor-bootstrap-d275de6c.js";import"./vendor-jquery-89b63fca.js";import"./vendor-axios-13ef03ae.js";import"./vendor-sortablejs-ad1d2cc8.js";import"./vendor-luxon-1af9332f.js";B.add(I,A,E,R,L);$.register(H,V,z,T,F,N,O,J,Z);const Q={name:"OpenwbMonthlyChart",components:{ChartjsLine:G,FontAwesomeIcon:P},mixins:[M],emits:["sendCommand"],data(){return{mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/monthly/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentMonth:"",monthlyChartRequestData:{month:"",year:""},datasetTemplates:{"counter-energyImport":{label:"Zähler",unit:"kWh",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"counter-energyExport":{label:"Zähler",unit:"kWh",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-energyExport":{label:"PV",unit:"kWh",jsonKey:null,borderColor:"rgba(0, 255, 0, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-energyImport":{label:"Speicher",unit:"kWh",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-energyExport":{label:"Speicher",unit:"kWh",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-energyImport":{label:"Ladepunkt",unit:"kWh",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"sh-energyImport":{label:"SmartHome",unit:"kWh",jsonKey:null,borderColor:"rgba(232, 62, 140, 0.7)",backgroundColor:"rgba(232, 72, 150, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"sh-energyExport":{label:"SmartHome",unit:"kWh",jsonKey:null,borderColor:"rgba(232, 62, 140, 0.7)",backgroundColor:"rgba(232, 72, 150, 0.3)",fill:!0,pointStyle:"circle",pointRadius:0,pointHoverRadius:4,cubicInterpolationMode:"monotone",hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0,callbacks:{label:e=>`${e.dataset.label}: ${e.formattedValue} ${e.dataset.unit}`}},legend:{display:!0},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:2}},responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{unit:"day",tooltipFormat:"D"},display:!0,title:{display:!0,text:"Tag"},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:31},grid:{}},y:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Energie [kWh]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{monthlyChartDate:{get(){return this.monthlyChartRequestData.year+"-"+this.monthlyChartRequestData.month},set(e){let o=e.split("-");this.monthlyChartRequestData.year=o[0],this.monthlyChartRequestData.month=o[1]}},commandData(){return{month:this.monthlyChartRequestData.year+this.monthlyChartRequestData.month}},chartDataRead(){return this.chartDataObject!=null},chartDataHasEntries(){return this.chartDataObject?this.chartDataObject.length>0:!1},chartTotals(){if(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month]){if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month],"totals"))return this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month].totals;{var e={bat:{},counter:{},pv:{},cp:{}};const t=["imported","exported"],l=(r,a,c)=>{const p=c.split(".");t.includes(p[p.length-1])&&(Object.prototype.hasOwnProperty.call(e[p[0]],[p[1]])||(e[p[0]][p[1]]={}),e[p[0]][p[1]][p[2]]=Math.floor(a-r))},s=(r,a,c,p="")=>{for(var h in a)a[h]!==null&&typeof a[h]=="object"?s(r[h],a[h],c,p?p+"."+h:h):c.apply(this,[r[h],a[h],p?p+"."+h:h])};var o=this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month];const n=o[0],i=o[o.length-1];return s(n,i,l),e}}},chartDataObject(){if(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month]){var e=this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month];Object.prototype.hasOwnProperty.call(e,"entries")&&(console.debug("upgraded chart data received"),e=e.entries);var o=JSON.parse(JSON.stringify(e)).map((t,l,s)=>{if(s.length>l+1){const i=s[l+1];t.timestamp=t.timestamp*1e3;var n=["pv","counter","bat","cp","sh"];return n.forEach(r=>{Object.entries(t[r]).forEach(([a,c])=>{t[r][a]&&Object.keys(c).forEach(()=>{switch(r){case"pv":Object.prototype.hasOwnProperty.call(i[r][a],"exported")&&Object.prototype.hasOwnProperty.call(t[r][a],"exported")&&(t[r][a].energyExport=(i[r][a].exported-t[r][a].exported)/1e3);break;case"counter":Object.prototype.hasOwnProperty.call(i[r][a],"imported")&&Object.prototype.hasOwnProperty.call(t[r][a],"imported")&&(t[r][a].energyImport=(i[r][a].imported-t[r][a].imported)/1e3),Object.prototype.hasOwnProperty.call(i[r][a],"exported")&&Object.prototype.hasOwnProperty.call(t[r][a],"exported")&&(t[r][a].energyExport=(i[r][a].exported-t[r][a].exported)/1e3);break;case"bat":Object.prototype.hasOwnProperty.call(i[r][a],"imported")&&Object.prototype.hasOwnProperty.call(t[r][a],"imported")&&(t[r][a].energyImport=(i[r][a].imported-t[r][a].imported)/1e3),Object.prototype.hasOwnProperty.call(i[r][a],"exported")&&Object.prototype.hasOwnProperty.call(t[r][a],"exported")&&(t[r][a].energyExport=(i[r][a].exported-t[r][a].exported)/1e3);break;case"cp":Object.prototype.hasOwnProperty.call(i[r][a],"imported")&&Object.prototype.hasOwnProperty.call(t[r][a],"imported")&&(t[r][a].energyImport=(i[r][a].imported-t[r][a].imported)/1e3);break;case"sh":Object.prototype.hasOwnProperty.call(i[r][a],"imported")&&Object.prototype.hasOwnProperty.call(t[r][a],"imported")&&(t[r][a].energyImport=(i[r][a].imported-t[r][a].imported)/1e3),Object.prototype.hasOwnProperty.call(i[r][a],"exported")&&Object.prototype.hasOwnProperty.call(t[r][a],"exported")&&(t[r][a].energyExport=(i[r][a].exported-t[r][a].exported)/1e3);break}})})}),t}else return});return o.pop(),o}},chartData(){if(this.chartDataObject){var e=["pv","counter","bat","cp","sh"];const o=this.chartDataObject[this.chartDataObject.length-1];return o&&e.forEach(t=>{Object.entries(o[t]).forEach(([l,s])=>{Object.keys(s).forEach(n=>{this.initDataset(t,l,n)})})}),this.chartDatasets}}},methods:{getCardSubtype(e){switch(e){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";case"sh":return"pink";default:return"secondary"}},getCardIcon(e){switch(e){case"bat":return["fas","car-battery"];case"counter":return["fas","gauge-high"];case"cp":return["fas","charging-station"];case"pv":return["fas","solar-panel"];case"sh":return["fas","house-signal"];default:return}},getDatasetHidden(e,o){return console.debug("getDatasetHidden",e,o),!1},getTotalsLabel(e,o=void 0,t=void 0){var l="*test*";if(!o&&!t){switch(e){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";case"sh":return"SmartHome-Geräte";default:console.warn("unknown group key:",e)}return"*"+e+"*"}if(o&&!t){if(o=="all")return"Summe";if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month],"names"))return this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month].names[o];var s=o.match(/\d+$/),n="";switch(e){case"cp":n="openWB/chargepoint/"+s+"/config";break;case"ev":n="openWB/vehicle/"+s+"/name";break;default:n="openWB/system/device/+/component/"+s+"/config"}var i=Object.keys(this.getWildcardTopics(n))[0];if(i)switch(e){case"pv":return this.$store.state.mqtt[i].name;case"counter":return this.$store.state.mqtt[i].name;case"bat":return this.$store.state.mqtt[i].name;case"cp":return this.$store.state.mqtt[i].name;case"ev":return this.$store.state.mqtt[i];case"sh":return"SmartHome*";default:console.warn("unknown group key:",e)}else console.warn("topic not found for:",e,o);return"+"+e+"+"+o+"+"}if(o&&t){switch(e){case"bat":case"cp":switch(t){case"imported":return"Ladung";case"exported":return"Entladung";default:console.warn("unknown measurement key:",e,t)}break;case"counter":switch(t){case"imported":return"Bezug/Verbrauch";case"exported":return"Einspeisung/Erzeugung";default:console.warn("unknown measurement key:",e,t)}break;case"pv":switch(t){case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,t)}break;case"sh":switch(t){case"imported":return"Verbrauch";case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",e,t)}break;default:console.warn("unknown group key:",e)}return"*"+e+"+"+o+"+"+t+"*"}return l},getDatasetLabel(e,o,t,l){var s=["*"+l],n=[];if(o=="all")switch(n.push("Summe"),e){case"pv":s=["PV"];break;case"bat":switch(s=["Speicher"],t){case"soc":s.push("SoC");break}break;case"cp":switch(s=["Ladepunkte"],t){case"soc":s.push("SoC");break}break}else if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month],"names")&&Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month].names,o))s=[this.$store.state.mqtt["openWB/log/monthly/"+this.commandData.month].names[o]];else{var i=o.match(/\d+$/),r="";switch(e){case"cp":r="openWB/chargepoint/"+i+"/config";break;case"ev":r="openWB/vehicle/"+i+"/name";break;default:r="openWB/system/device/+/component/"+i+"/config"}var a=Object.keys(this.getWildcardTopics(r))[0];if(a in this.$store.state.mqtt)switch(e){case"pv":s=[this.$store.state.mqtt[a].name];break;case"counter":s=[this.$store.state.mqtt[a].name];break;case"bat":switch(s=[this.$store.state.mqtt[a].name],t){case"soc":s.push("SoC");break}break;case"cp":switch(s=[this.$store.state.mqtt[a].name],t){case"soc":s.push("SoC");break}break;case"sh":switch(s=[this.$store.state.mqtt[a].name],t){case"temp1":case"temp2":case"temp3":s.push(t.charAt(0).toUpperCase()+t.substring(1));break}break;case"ev":switch(s=[this.$store.state.mqtt[a]],t){case"soc":s.push("SoC");break}break}else console.warn("could not get name for dataset",l)}switch(e){case"bat":case"cp":switch(t){case"imported":case"energyImport":n.push("Ladung");break;case"exported":case"energyExport":n.push("Entladung");break}break;case"counter":switch(t){case"imported":case"energyImport":n.push("Bezug/Verbrauch");break;case"exported":case"energyExport":n.push("Einspeisung/Erzeugung");break}break}return console.debug("getDatasetLabel",e,o,t,l,"Label:",s,n),`${s.join(" ")}${n.length?" ("+n.join(", ")+")":""}`},getDatasetIndex(e){let o=this.chartDatasets.datasets.findIndex(t=>t.jsonKey==e);if(o!=-1)return o},addDataset(e,o,t,l){console.debug("adding new dataset",e,o,t,l);var s=e+"-"+t;if(this.datasetTemplates[s]){var n=JSON.parse(JSON.stringify(this.datasetTemplates[s]));return n.parsing.yAxisKey=l,n.jsonKey=l,n.data=this.chartDataObject,n.label=this.getDatasetLabel(e,o,t,l),n.labelSuffix!=null&&(n.label=n.label+n.labelSuffix),o=="all"&&(n.hidden=!1),this.chartDatasets.datasets.push(n)-1}else console.warn("no matching template found for: "+l+" with template: "+s)},initDataset(e,o,t){const l=["energyImport","energyExport"],s=e+"."+o+"."+t;if(l.includes(t)){var n=this.getDatasetIndex(s);const i=this.getDatasetHidden(e,o);n==null&&!i&&(n=this.addDataset(e,o,t,s)),n!=null&&i&&(console.info("component hidden:",e,o,t,n),this.chartDatasets.datasets.splice(n,1))}},requestMonthlyChart(){if(document.forms.monthlyChartForm.reportValidity())this.chartDatasets.datasets=[],this.$emit("sendCommand",{command:"getMonthlyLog",data:this.commandData});else{console.log("form invalid");return}},clearChartData(){this.getWildcardIndexList("openWB/log/monthly/+").forEach(e=>{this.$store.commit("removeTopic",`openWB/log/monthly/${e}`)})},updateChart(){this.clearChartData(),this.requestMonthlyChart()}},mounted(){const e=new Date;this.currentMonth=this.monthlyChartDate=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0"),this.requestMonthlyChart()}},Y={class:"monthlyChart"},X={name:"monthlyChartForm"},j={key:1},K={key:1},tt={class:"openwb-chart"};function et(e,o,t,l,s,n){const i=y("openwb-base-text-input"),r=y("openwb-base-card"),a=y("openwb-base-alert"),c=y("chartjs-line"),p=y("font-awesome-icon"),h=y("openwb-base-heading");return d(),u("div",Y,[w("form",X,[m(r,{title:"Filter",collapsible:!0,collapsed:!1},{default:g(()=>[m(i,{title:"Monat",subtype:"month",min:"2018-01",max:s.currentMonth,showQuickButtons:!0,modelValue:n.monthlyChartDate,"onUpdate:modelValue":[o[0]||(o[0]=x=>n.monthlyChartDate=x),o[1]||(o[1]=x=>n.updateChart())]},null,8,["max","modelValue"])]),_:1}),n.chartDataRead?(d(),u("div",j,[n.chartDataHasEntries?(d(),u("div",K,[m(r,{title:"Diagramm",collapsible:!0,collapsed:!1},{default:g(()=>[w("div",tt,[m(c,{data:n.chartData,options:s.chartOptions},null,8,["data","options"])])]),_:1}),m(r,{title:"Summen",collapsible:!0,collapsed:!0},{default:g(()=>[(d(!0),u(D,null,_(n.chartTotals,(x,f)=>(d(),C(r,{key:f,collapsible:!0,collapsed:!0,subtype:n.getCardSubtype(f)},{header:g(()=>[m(p,{"fixed-width":"",icon:n.getCardIcon(f)},null,8,["icon"]),b(" "+W(n.getTotalsLabel(f)),1)]),default:g(()=>[(d(!0),u(D,null,_(x,(S,v)=>(d(),u("div",{key:v},[m(h,null,{default:g(()=>[b(W(n.getTotalsLabel(f,v)),1)]),_:2},1024),(d(!0),u(D,null,_(S,(q,k)=>(d(),u("div",{key:k},[m(i,{title:n.getTotalsLabel(f,v,k),readonly:"",class:"text-right",unit:"kWh","model-value":e.formatNumber(q/1e3,3)},null,8,["title","model-value"])]))),128))]))),128))]),_:2},1032,["subtype"]))),128))]),_:1})])):(d(),C(a,{key:0,subtype:"info"},{default:g(()=>[b(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ")]),_:1}))])):(d(),C(a,{key:0,subtype:"info"},{default:g(()=>[b(" Es wurden noch keine Daten abgerufen. ")]),_:1}))])])}const dt=U(Q,[["render",et],["__scopeId","data-v-f311d5b6"],["__file","/opt/openWB-dev/openwb-ui-settings/src/views/MonthlyChart.vue"]]);export{dt as default};
