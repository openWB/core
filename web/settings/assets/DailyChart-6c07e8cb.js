import{l as L,J as B,K as A,L as E,M as T,F as P}from"./vendor-fortawesome-221885f6.js";import{C as M}from"./index-7b686d60.js";import{C as z,p as $,a as I,L as F,b as V,P as N,c as H,T as J,i as Z,d as G,e as U}from"./vendor-chartjs-e4b5eddf.js";import{_ as Y,p as y,l as c,q as S,A as h,L as m,y as C,k as u,u as D,G as _,I as b,x as w}from"./vendor-93bd3532.js";import"./vendor-bootstrap-ca63a7a7.js";import"./vendor-jquery-15a435dc.js";import"./vendor-axios-566cac60.js";import"./vendor-sortablejs-b80cade1.js";import"./vendor-luxon-1af9332f.js";L.add(B,A,E,T);z.register($,I,F,V,N,H,J,Z,G);const O={name:"OpenwbDailyChart",components:{ChartjsLine:U,FontAwesomeIcon:P},mixins:[M],emits:["sendCommand"],data(){return{mqttTopicsToSubscribe:["openWB/general/extern","openWB/log/daily/#","openWB/system/device/+/component/+/config","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentDay:"",dailyChartRequestData:{day:"",month:"",year:""},datasetTemplates:{"counter-power":{label:"Zähler",jsonKey:null,borderColor:"rgba(255, 0, 0, 0.7)",backgroundColor:"rgba(255, 10, 13, 0.3)",fill:!0,lineTension:.2,hidden:!1,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"pv-power":{label:"PV",jsonKey:null,borderColor:"rgba(0, 255, 0, 0.7)",backgroundColor:"rgba(10, 255, 13, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-power":{label:"Speicher",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"bat-soc":{label:"Speicher SoC",jsonKey:null,borderColor:"rgba(255, 153, 13, 0.7)",backgroundColor:"rgba(200, 255, 13, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,lineTension:.2,borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"cp-power":{label:"Ladepunkt",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",fill:!0,lineTension:.2,hidden:!0,borderWidth:1,data:null,yAxisID:"y",parsing:{xAxisKey:"timestamp",yAxisKey:null}},"ev-soc":{label:"Fahrzeug SoC",jsonKey:null,borderColor:"rgba(0, 0, 255, 0.7)",backgroundColor:"rgba(0, 0, 255, 0.3)",borderDash:[10,5],hidden:!0,fill:!1,lineTension:.2,borderWidth:2,data:null,yAxisID:"y2",parsing:{xAxisKey:"timestamp",yAxisKey:null}}},chartOptions:{plugins:{title:{display:!1},tooltip:{enabled:!0},legend:{display:!0},zoom:{pan:{enabled:!0,mode:"x",threshold:5},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"x"}}},elements:{point:{radius:0}},responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",time:{unit:"minute",tooltipFormat:"DD T"},display:!0,title:{display:!0,text:"Zeit"},ticks:{source:"timestamp",font:{size:12},maxTicksLimit:24},grid:{}},y:{position:"left",type:"linear",display:"auto",suggestedMin:0,suggestedMax:0,title:{font:{size:12},display:!0,text:"Leistung [kW]"},grid:{},ticks:{font:{size:12},stepSize:.2,maxTicksLimit:11}},y2:{position:"right",type:"linear",display:"auto",suggestedMin:0,suggestedMax:100,title:{font:{size:12},display:!0,text:"SoC [%]"},grid:{display:!1},ticks:{font:{size:12},stepSize:10,maxTicksLimit:11}}}},chartDatasets:{datasets:[]}}},computed:{dailyChartDate:{get(){return this.dailyChartRequestData.year+"-"+this.dailyChartRequestData.month+"-"+this.dailyChartRequestData.day},set(a){let t=a.split("-");this.dailyChartRequestData.year=t[0],this.dailyChartRequestData.month=t[1],this.dailyChartRequestData.day=t[2]}},commandData(){return{day:this.dailyChartRequestData.year+this.dailyChartRequestData.month+this.dailyChartRequestData.day}},chartDataRead(){return this.chartDataObject!=null},chartDataHasEntries(){return this.chartDataObject?this.chartDataObject.length>0:!1},chartTotals(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){if(Object.prototype.hasOwnProperty.call(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day],"totals"))return this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day].totals;{var a={bat:{},counter:{},pv:{},cp:{}};const o=["imported","exported"],s=(r,d,f)=>{const l=f.split(".");o.includes(l[l.length-1])&&(Object.prototype.hasOwnProperty.call(a[l[0]],[l[1]])||(a[l[0]][l[1]]={}),a[l[0]][l[1]][l[2]]=Math.floor(d-r))},i=(r,d,f,l="")=>{for(var p in d)d[p]!==null&&typeof d[p]=="object"?i(r[p],d[p],f,l?l+"."+p:p):f.apply(this,[r[p],d[p],l?l+"."+p:p])};var t=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];const n=t[0],e=t[t.length-1];return i(n,e,s),a}}},chartDataObject(){if(this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day]){var a=this.$store.state.mqtt["openWB/log/daily/"+this.commandData.day];Object.prototype.hasOwnProperty.call(a,"entries")&&(console.debug("upgraded chart data received"),a=a.entries);var t=void 0,o=JSON.parse(JSON.stringify(a)).map(s=>{if(s.timestamp=s.timestamp*1e3,t!==void 0){const n=s.timestamp-t.timestamp;var i=["pv","counter","bat","cp"];return i.forEach(e=>{Object.entries(s[e]).forEach(([r,d])=>{t[e][r]&&Object.keys(d).forEach(()=>{switch(e){case"pv":Object.prototype.hasOwnProperty.call(s[e][r],"exported")&&Object.prototype.hasOwnProperty.call(t[e][r],"exported")&&(s[e][r].power=Math.floor((s[e][r].exported-t[e][r].exported)/(n/1e3/3600))/1e3);break;case"counter":Object.prototype.hasOwnProperty.call(s[e][r],"imported")&&Object.prototype.hasOwnProperty.call(t[e][r],"imported")&&Object.prototype.hasOwnProperty.call(s[e][r],"exported")&&Object.prototype.hasOwnProperty.call(t[e][r],"exported")&&(s[e][r].power=Math.floor((s[e][r].imported-t[e][r].imported-(s[e][r].exported-t[e][r].exported))/(n/1e3/3600))/1e3,s[e][r].powerImport=Math.max(0,s[e][r].power),s[e][r].powerExport=Math.min(0,s[e][r].power));break;case"bat":Object.prototype.hasOwnProperty.call(s[e][r],"imported")&&Object.prototype.hasOwnProperty.call(t[e][r],"imported")&&Object.prototype.hasOwnProperty.call(s[e][r],"exported")&&Object.prototype.hasOwnProperty.call(t[e][r],"exported")&&(s[e][r].power=Math.floor((s[e][r].imported-t[e][r].imported-(s[e][r].exported-t[e][r].exported))/(n/1e3/3600))/1e3,s[e][r].powerImport=Math.max(0,s[e][r].power),s[e][r].powerExport=Math.min(0,s[e][r].power));break;case"cp":Object.prototype.hasOwnProperty.call(s[e][r],"imported")&&Object.prototype.hasOwnProperty.call(t[e][r],"imported")&&(s[e][r].power=Math.floor((s[e][r].imported-t[e][r].imported)/(n/1e3/3600))/1e3);break}})})}),t=s,s}else{t=s;return}});return o.shift(),o}},chartData(){if(this.chartDataObject){var a=["pv","counter","bat","cp","ev"];const t=this.chartDataObject[this.chartDataObject.length-1];return t&&a.forEach(o=>{Object.entries(t[o]).forEach(([s,i])=>{Object.keys(i).forEach(n=>{this.initDataset(o,s,n)})})}),this.chartDatasets}}},methods:{getCardSubtype(a){switch(a){case"bat":return"warning";case"counter":return"danger";case"cp":return"primary";case"pv":return"success";default:return"secondary"}},getCardIcon(a){switch(a){case"bat":return["fas","car-battery"];case"counter":return["fas","gauge-high"];case"cp":return["fas","charging-station"];case"pv":return["fas","solar-panel"];default:return}},getDatasetHidden(a,t){return console.debug("getDatasetHidden",a,t),!1},getTotalsLabel(a,t=void 0,o=void 0){var s="*test*";if(!t&&!o){switch(a){case"bat":return"Speicher";case"counter":return"Zähler";case"pv":return"Wechselrichter";case"cp":return"Ladepunkte";default:console.warn("unknown group key:",a)}return"*"+a+"*"}if(t&&!o){if(t=="all")return"Summe";var i=t.match(/\d+$/),n="";switch(a){case"cp":n="openWB/chargepoint/"+i+"/config";break;case"ev":n="openWB/vehicle/"+i+"/name";break;default:n="openWB/system/device/+/component/"+i+"/config"}var e=Object.keys(this.getWildcardTopics(n))[0];if(e)switch(a){case"pv":return this.$store.state.mqtt[e].name;case"counter":return this.$store.state.mqtt[e].name;case"bat":return this.$store.state.mqtt[e].name;case"cp":return this.$store.state.mqtt[e].name;case"ev":return this.$store.state.mqtt[e];default:console.warn("unknown group key:",a)}else console.warn("topic not found for:",a,t);return"+"+a+"+"+t+"+"}if(t&&o){switch(a){case"bat":case"cp":switch(o){case"imported":return"Ladung";case"exported":return"Entladung";default:console.warn("unknown measurement key:",a,o)}break;case"counter":switch(o){case"imported":return"Bezug/Verbrauch";case"exported":return"Einspeisung/Erzeugung";default:console.warn("unknown measurement key:",a,o)}break;case"pv":switch(o){case"exported":return"Erzeugung";default:console.warn("unknown measurement key:",a,o)}break;default:console.warn("unknown group key:",a)}return"*"+a+"+"+t+"+"+o+"*"}return s},getDatasetLabel(a,t,o,s){var i="*"+s;if(t=="all")switch(a){case"pv":i="PV (Summe)";break;case"bat":switch(i="Speicher",o){case"imported":i+=" (Ladung, Summe)";break;case"exported":i+=" (Entladung, Summe)";break;case"soc":i+=" SoC (Summe)";break;default:i+=" (Summe)"}break;case"cp":switch(i="Ladepunkte",o){case"imported":i+=" (Ladung, Summe)";break;case"exported":i+=" (Entladung, Summe)";break;case"soc":i+=" SoC (Summe)";break;default:i+=" (Summe)"}break}else{var n=t.match(/\d+$/),e="";switch(a){case"cp":e="openWB/chargepoint/"+n+"/config";break;case"ev":e="openWB/vehicle/"+n+"/name";break;default:e="openWB/system/device/+/component/"+n+"/config"}var r=Object.keys(this.getWildcardTopics(e))[0];if(r in this.$store.state.mqtt)switch(a){case"pv":i=this.$store.state.mqtt[r].name;break;case"counter":switch(i=this.$store.state.mqtt[r].name,o){case"imported":i+=" (Bezug)";break;case"exported":i+=" (Einspeisung)";break}break;case"bat":switch(i=this.$store.state.mqtt[r].name,o){case"imported":i+=" (Ladung)";break;case"exported":i+=" (Entladung)";break;case"soc":i+=" SoC";break}break;case"cp":switch(i=this.$store.state.mqtt[r].name,o){case"imported":i+=" (Ladung)";break;case"exported":i+=" (Entladung)";break;case"soc":i+=" SoC";break}break;case"ev":i=this.$store.state.mqtt[r];break}else console.warn("could not get name for dataset",s)}return i},getDatasetIndex(a){let t=this.chartDatasets.datasets.findIndex(o=>o.jsonKey==a);if(t!=-1)return t},addDataset(a,t,o,s){console.debug("adding new dataset",a,t,o,s);var i=a+"-"+o;if(this.datasetTemplates[i]){var n=JSON.parse(JSON.stringify(this.datasetTemplates[i]));return n.parsing.yAxisKey=s,n.jsonKey=s,n.data=this.chartDataObject,n.label=this.getDatasetLabel(a,t,o,s),n.labelSuffix!=null&&(n.label=n.label+n.labelSuffix),t=="all"&&(n.hidden=!1),this.chartDatasets.datasets.push(n)-1}else console.warn("no matching template found for: "+s+" with template: "+i)},initDataset(a,t,o){const s=["power","soc"],i=a+"."+t+"."+o;if(s.includes(o)){var n=this.getDatasetIndex(i);const e=this.getDatasetHidden(a,t);n==null&&!e&&(n=this.addDataset(a,t,o,i)),n!=null&&e&&(console.info("component hidden:",a,t,o,n),this.chartDatasets.datasets.splice(n,1))}},requestDailyChart(){if(document.forms.dailyChartForm.reportValidity())this.chartDatasets.datasets=[],this.$emit("sendCommand",{command:"getDailyLog",data:this.commandData});else{console.log("form invalid");return}},clearChartData(){this.getWildcardIndexList("openWB/log/daily/+").forEach(a=>{this.$store.commit("removeTopic",`openWB/log/daily/${a}`)})},updateChart(){this.clearChartData(),this.requestDailyChart()}},mounted(){const a=new Date;this.currentDay=this.dailyChartDate=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0"),this.requestDailyChart()}},Q={class:"dailyChart"},X={name:"dailyChartForm"},R={key:1},j={key:1},K={class:"openwb-chart"};function tt(a,t,o,s,i,n){const e=y("openwb-base-text-input"),r=y("openwb-base-card"),d=y("openwb-base-alert"),f=y("chartjs-line"),l=y("font-awesome-icon"),p=y("openwb-base-heading");return u(),c("div",Q,[S("form",X,[h(r,{title:"Filter",collapsible:!0,collapsed:!1},{default:m(()=>[h(e,{title:"Datum",subtype:"date",min:"2018-01-01",max:i.currentDay,modelValue:n.dailyChartDate,"onUpdate:modelValue":[t[0]||(t[0]=x=>n.dailyChartDate=x),t[1]||(t[1]=x=>n.updateChart())]},null,8,["max","modelValue"])]),_:1}),n.chartDataRead?(u(),c("div",R,[n.chartDataHasEntries?(u(),c("div",j,[h(r,{title:"Diagramm",collapsible:!0,collapsed:!1},{default:m(()=>[S("div",K,[h(f,{data:n.chartData,options:i.chartOptions},null,8,["data","options"])])]),_:1}),h(r,{title:"Summen",collapsible:!0,collapsed:!0},{default:m(()=>[(u(!0),c(_,null,b(n.chartTotals,(x,g)=>(u(),C(r,{key:g,collapsible:!0,collapsed:!0,subtype:n.getCardSubtype(g)},{header:m(()=>[h(l,{"fixed-width":"",icon:n.getCardIcon(g)},null,8,["icon"]),D(" "+w(n.getTotalsLabel(g)),1)]),default:m(()=>[(u(!0),c(_,null,b(x,(q,v)=>(u(),c("div",{key:v},[h(p,null,{default:m(()=>[D(w(n.getTotalsLabel(g,v)),1)]),_:2},1024),(u(!0),c(_,null,b(q,(W,k)=>(u(),c("div",{key:k},[h(e,{title:n.getTotalsLabel(g,v,k),readonly:"",class:"text-right",unit:"kWh","model-value":a.formatNumber(W/1e3,3)},null,8,["title","model-value"])]))),128))]))),128))]),_:2},1032,["subtype"]))),128))]),_:1})])):(u(),C(d,{key:0,subtype:"info"},{default:m(()=>[D(" Es konnten keine Daten für diesen Zeitraum gefunden werden. ")]),_:1}))])):(u(),C(d,{key:0,subtype:"info"},{default:m(()=>[D(" Es wurden noch keine Daten abgerufen. ")]),_:1}))])])}const pt=Y(O,[["render",tt],["__scopeId","data-v-cea01f9f"],["__file","/opt/openWB-dev/openwb-ui-settings/src/views/DailyChart.vue"]]);export{pt as default};
