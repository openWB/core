import{l as C,N as R,O as k,F as q}from"./vendor-fortawesome-12414438.js";import{_ as x,Z as E,q as l,l as h,m,u as c,A as i,K as r,v as d,y as V,z as v,P as F,Q as y}from"./vendor-b78ff8c0.js";import{C as B}from"./index-83acc078.js";import"./vendor-sortablejs-116030fd.js";import"./vendor-bootstrap-760bc08d.js";import"./vendor-jquery-41669b5b.js";import"./vendor-axios-a6fb860e.js";C.add(R,k);const N={name:"OpenwbChargeLog",components:{Vue3TableLite:E,FontAwesomeIcon:q},mixins:[B],emits:["sendCommand"],data(){return{dateTimeFormat:new Intl.DateTimeFormat("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),mqttTopicsToSubscribe:["openWB/general/extern","openWB/chargepoint/+/config","openWB/vehicle/+/name"],currentMonth:"",chargeLogRequestData:{month:"",year:"",filter:{chargepoint:{id:[]},vehicle:{id:[],chargemode:[],prio:void 0}}},downloadFile:null,table:{messages:{pagingInfo:"Einträge {0}-{1} von {2}",pageSizeChangeLabel:"Einträge:",gotoPageLabel:" Gehe zu:",noDataAvailable:"Keine Einträge gefunden."},pageOptions:[{value:5,text:"5"},{value:10,text:"10"},{value:25,text:"25"},{value:50,text:"50"},{value:100,text:"100"}],columns:[{label:"Beginn",field:"time_begin",sortable:!0},{label:"Ende",field:"time_end",sortable:!0},{label:"Fahrzeug",field:"vehicle_name",sortable:!0},{label:"Dauer",field:"time_time_charged",sortable:!0,display:e=>this.alignEnd(e.time_time_charged)},{label:"Energie",field:"data_imported_since_mode_switch",sortable:!0,display:e=>this.alignEnd(this.formatNumber(e.data_imported_since_mode_switch/1e3,2)+"&nbsp;kWh / "+this.formatNumber(e.data_range_charged,0)+"&nbsp;km")},{label:"Kosten",field:"data_costs",sortable:!0,display:e=>this.alignEnd(this.formatNumber(e.data_costs,2)+"&nbsp;€")},{label:"Lademodus",field:"vehicle_chargemode",sortable:!0,display:e=>'<div class="td-center tag '+this.getChargeModeClass(e.vehicle_chargemode)+'">'+e.vehicle_chargemode+"</div>"},{label:"Ladepunkt",field:"chargepoint_name",sortable:!0},{label:"Priorität",field:"vehicle_prio",display:e=>this.translateBool(e.vehicle_prio)}],sortable:{order:"timestamp_begin",sort:"asc"}},totals:{columns:[{label:"Dauer",field:"time_charged",sortable:!1,display:e=>this.alignEnd(e.time_charged)},{label:"Energie",field:"imported_since_mode_switch",sortable:!1,display:e=>this.alignEnd(this.formatNumber(e.imported_since_mode_switch/1e3,2)+"&nbsp;kWh")},{label:"Reichweite",field:"range_charged",sortable:!1,display:e=>this.alignEnd(this.formatNumber(e.range_charged,0)+"&nbsp;km")},{label:"Kosten",field:"costs",sortable:!1,display:e=>this.alignEnd(this.formatNumber(e.costs,2)+"&nbsp;€")}]}}},computed:{chargeLogDate:{get(){return this.chargeLogRequestData.year+"-"+this.chargeLogRequestData.month},set(e){let t=e.split("-");this.chargeLogRequestData.year=t[0],this.chargeLogRequestData.month=t[1]}},chargeLogTotals(){return this.$store.state.mqtt["openWB/log/"+this.mqttClientId+"/data"]?[this.$store.state.mqtt["openWB/log/"+this.mqttClientId+"/data"].totals]:[]},chargeLogDataset:{get(){try{return this.$store.state.mqtt["openWB/log/"+this.mqttClientId+"/data"].entries.map(e=>{var t=Date.parse(e.time.begin),o=Date.parse(e.time.end);return{chargepoint_id:e.chargepoint.id,chargepoint_name:e.chargepoint.name,vehicle_id:e.vehicle.id,vehicle_name:e.vehicle.name,vehicle_chargemode:this.translateChargeMode(e.vehicle.chargemode),vehicle_rfid:e.vehicle.rfid,vehicle_prio:e.vehicle.prio,timestamp_begin:t/1e3,time_begin:this.dateTimeFormat.format(new Date(t)),timestamp_end:o/1e3,time_end:this.dateTimeFormat.format(new Date(o)),time_time_charged:e.time.time_charged,data_power:e.data.power,data_range_charged:e.data.range_charged,data_costs:e.data.costs,data_imported_since_plugged:e.data.imported_since_plugged,data_imported_since_mode_switch:e.data.imported_since_mode_switch}})}catch{return[]}}},chargeLogCsv:{get(){return[["Ladepunkt-ID","Ladepunkt","Fahrzeug-ID","Fahrzeug","Lademodus","Priorität","Beginn","Ende","Zeitstempel Beginn","Zeitstempel Ende","Dauer","Leistung","Energie","Reichweite","Kosten"],...this.chargeLogDataset.map(t=>[t.chargepoint_id,'"'+t.chargepoint_name+'"',t.vehicle_id,'"'+t.vehicle_name+'"','"'+t.vehicle_chargemode+'"','"'+this.translateBool(t.vehicle_prio,!1)+'"','"'+t.time_begin+'"','"'+t.time_end+'"','"'+t.timestamp_begin+'"','"'+t.timestamp_end+'"','"'+t.time_time_charged+'"',this.formatNumber(t.data_power/1e3,3),this.formatNumber(t.data_imported_since_mode_switch/1e3,2),this.formatNumber(t.data_range_charged,0),this.formatNumber(t.data_costs,2)])].map(t=>t.join(";")).join(`
`)}},chargeLogRead:{get(){return this.chargeLogDataset!=null}},chargeLogHasEntries:{get(){return this.chargeLogDataset==null?!1:this.chargeLogDataset.length>0}},totalRecordCount(){return this.chargeLogDataset.length},chargeModeList(){let e=this.chargeModes.map(t=>({value:t,text:this.translateChargeMode(t)}));return e.unshift({value:void 0,text:"Alle"}),e},chargePointList(){let e=this.getWildcardTopics("openWB/chargepoint/+/config");var t=[{value:void 0,text:"Alle"}];for(const[,o]of Object.entries(e))t.push({value:o.id,text:o.name});return t},vehicleList(){let e=this.getWildcardTopics("openWB/vehicle/+/name");var t=[{value:void 0,text:"Alle"}];for(const[o,g]of Object.entries(e)){let a=parseInt(o.match(/\/([0-9]+)\/name$/)[1]);t.push({value:a,text:g})}return t}},methods:{cleanRequestData(){"id"in this.chargeLogRequestData.filter.chargepoint&&(this.chargeLogRequestData.filter.chargepoint.id=this.chargeLogRequestData.filter.chargepoint.id.filter(e=>e!=null)),"chargemode"in this.chargeLogRequestData.filter.vehicle&&(this.chargeLogRequestData.filter.vehicle.chargemode=this.chargeLogRequestData.filter.vehicle.chargemode.filter(e=>e!=null)),"id"in this.chargeLogRequestData.filter.vehicle&&(this.chargeLogRequestData.filter.vehicle.id=this.chargeLogRequestData.filter.vehicle.id.filter(e=>e!=null))},requestChargeLog(){if(document.forms.chargeLogForm.reportValidity())this.cleanRequestData(),this.$emit("sendCommand",{command:"getChargeLog",data:this.chargeLogRequestData});else{console.log("form invalid");return}},makeTextFile(e){var t=new Blob([e],{type:"text/csv"});return this.downloadFile!==null&&window.URL.revokeObjectURL(this.downloadFile),this.downloadFile=window.URL.createObjectURL(t),this.downloadFile},downloadChargeLog(){this.$refs.downloadChargeLogLink.setAttribute("download","Ladeprotokoll-"+this.chargeLogDate+".csv"),this.$refs.downloadChargeLogLink.href=this.makeTextFile(this.chargeLogCsv),this.$refs.downloadChargeLogLink.dispatchEvent(new MouseEvent("click"))},alignEnd(e){return'<div class="td-end">'+e+"</div>"},alignCenter(e){return'<div class="td-center">'+e+"</div>"},translateBool(e,t=!0){let o="Nein",g="bg-danger";return e&&(o="Ja",g="bg-success"),t?'<div class="td-center tag '+g+'">'+o+"</div>":o},getChargeModeClass(e){switch(e){case"Sofort":return"bg-danger";case"PV":return"bg-success";case"Zielladen":return"bg-primary";case"Zeitladen":return"bg-warning";case"Standby":return"bg-secondary";case"Stop":return"bg-dark";default:return console.warn("unknown charge mode:",e),"bg-light"}},translateHeading(e){switch(e){case"time_charged":return"Dauer";case"range_charged":return"Reichweite";case"imported_since_mode_switch":return"Energie im Lademodus";case"imported_since_plugged":return"Energie seit Anstecken";case"power":return"Leistung";case"costs":return"Kosten";default:return console.warn("unknown heading:",e),e}}},mounted(){const e=new Date;this.currentMonth=this.chargeLogDate=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0"),this.requestChargeLog()}},T=e=>(F("data-v-8607e7e7"),e=e(),y(),e),S={class:"chargeLog"},I={name:"chargeLogForm"},M={class:"row justify-content-center"},W={key:1},A={key:0},O={class:"row justify-content-center"},P={class:"hide",ref:"downloadChargeLogLink"},U=T(()=>c("div",{class:"row"},[c("div",{class:"col"},[c("h2",null,"Summe")])],-1));function j(e,t,o,g,a,n){const L=l("openwb-base-text-input"),p=l("font-awesome-icon"),w=l("openwb-base-button-group-input"),u=l("openwb-base-select-input"),_=l("openwb-base-card"),b=l("openwb-base-click-button"),D=l("openwb-base-alert"),f=l("vue3-table-lite");return h(),m("div",S,[c("form",I,[i(_,{title:"Filter"},{footer:r(()=>[c("div",M,[i(b,{class:"col-4 btn-success",onButtonClicked:t[5]||(t[5]=s=>n.requestChargeLog())},{default:r(()=>[d(" Filter anwenden ")]),_:1})])]),default:r(()=>[i(L,{title:"Zeitraum",subtype:"month",min:"2018-01",max:a.currentMonth,modelValue:n.chargeLogDate,"onUpdate:modelValue":t[0]||(t[0]=s=>n.chargeLogDate=s)},null,8,["max","modelValue"]),i(_,{title:"Erweiterte Optionen",collapsible:!0,collapsed:!0},{header:r(()=>[i(p,{"fixed-width":"",icon:["fas","filter"]}),d(" Erweiterte Optionen ")]),default:r(()=>[i(w,{title:"Priorität",buttons:[{buttonValue:void 0,text:"Alle"},{buttonValue:!1,text:"Aus",class:"btn-outline-danger"},{buttonValue:!0,text:"An",class:"btn-outline-success"}],modelValue:a.chargeLogRequestData.filter.vehicle.prio,"onUpdate:modelValue":t[1]||(t[1]=s=>a.chargeLogRequestData.filter.vehicle.prio=s)},null,8,["modelValue"]),i(u,{title:"Lademodus",multiple:"",options:n.chargeModeList,modelValue:a.chargeLogRequestData.filter.vehicle.chargemode,"onUpdate:modelValue":t[2]||(t[2]=s=>a.chargeLogRequestData.filter.vehicle.chargemode=s)},{help:r(()=>[d(" Es können mehrere Elemente ausgewählt werden. ")]),_:1},8,["options","modelValue"]),i(u,{title:"Ladepunkt",multiple:"",options:n.chargePointList,modelValue:a.chargeLogRequestData.filter.chargepoint.id,"onUpdate:modelValue":t[3]||(t[3]=s=>a.chargeLogRequestData.filter.chargepoint.id=s)},{help:r(()=>[d(" Es können mehrere Elemente ausgewählt werden. ")]),_:1},8,["options","modelValue"]),i(u,{title:"Fahrzeug",multiple:"",options:n.vehicleList,modelValue:a.chargeLogRequestData.filter.vehicle.id,"onUpdate:modelValue":t[4]||(t[4]=s=>a.chargeLogRequestData.filter.vehicle.id=s)},{help:r(()=>[d(" Es können mehrere Elemente ausgewählt werden. ")]),_:1},8,["options","modelValue"])]),_:1})]),_:1}),n.chargeLogRead?(h(),m("div",W,[i(f,{class:"charge-log-table","is-static-mode":!0,columns:a.table.columns,rows:n.chargeLogDataset,total:n.totalRecordCount,sortable:a.table.sortable,messages:a.table.messages,"page-options":a.table.pageOptions,limit:25},null,8,["columns","rows","total","sortable","messages","page-options"]),n.totalRecordCount>0?(h(),m("div",A,[c("div",O,[i(b,{class:"col-4 btn-success",onButtonClicked:t[6]||(t[6]=s=>n.downloadChargeLog())},{default:r(()=>[d(" Als CSV exportieren "),i(p,{"fixed-width":"",icon:["fas","download"]})]),_:1}),c("a",P,null,512)]),U,v(" ToDo: build a table component "),i(f,{class:"charge-log-totals","is-static-mode":!0,"is-hide-paging":!0,columns:a.totals.columns,rows:n.chargeLogTotals,total:1},null,8,["columns","rows"])])):v("v-if",!0)])):(h(),V(D,{key:0,subtype:"info"},{default:r(()=>[d(" Es wurden noch keine Daten abgerufen. ")]),_:1}))])])}const Y=x(N,[["render",j],["__scopeId","data-v-8607e7e7"],["__file","/opt/openWB-dev/openwb-ui-settings/src/views/ChargeLog.vue"]]);export{Y as default};
